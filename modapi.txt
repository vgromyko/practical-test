<?
/// http://www.qrz.co.il/studio/vgromyko.info/projects/api/modapi.php
	
class ModelLogAgregator {
$hostname = "solidcam.db.7148117.hostedresource.com";
$username = "solidcam";
$dbname = "solidcam";

	//private $con = mysqli_connect("localhost","my_user","my_password","my_db");
	private $con = mysqli_connect("solidcam.db.7148117.hostedresource.com","solidcam","Solidcam1!","solidcam");
	
	function __construct() {
	
	}
	
	public function getLogData($dateFrom,$dateTo,$userId,$countryId){
	
		$sql="SELECT   cnt_title country , usr_name    
		     FROM  send_log sl ,  countries cnt  
			 WHERE    cnt.cnt_id = '$countryId'  OR  usr.usr_id = ',$userId'
			 LIMIT 2 "
		$result =  mysql_query($this->con, $sql );
		while ($row = mysql_fetch_assoc($result)) {
			$outLog['title'] = array(
							'Country'=>  $row['cnt_title'],
							'User'=>  $row['usr_name'],
							'From'=>  $dateTo,
							'To'=>  $dateTo 
							)
					}
		
		}
		
		

	
		$sql="SELECT   cnt_title country , usr_name  , log_created date,  $date_to SUM( IF(log_success , log_success ,0)) succs , SUM ( IF( !log_success ,1 ,0)) faild
			FROM  send_log sl
			WHERE  log_created >= '$dateFrom' AND  log_created <= '$dateTo'
			LEFT JOIN  users usr ON usr.usr_id = '$userId' AND 
			LEFT JOIN  countries cnt ON cnt.cnt_id = '$countryId' 
			GROUP BY log_created 
			ORDER BY log_created " ;
			
		$result =  mysql_query($this->con, $sql );
		
		if (!$result) {
 
			while ($row = mysql_fetch_assoc($result)) {
 
				$outLog['data'][] = array(
						'date'=> $row['date'],
						'success'=> ($row['succs']) ? $row['succs'] : '-' ,
						'failed '=> ($row['faild']) ? $row['faild'] : '-'
				) ;

			}
		}
		
		return $outLog ;
		
	}

	public function getCountriesList($countryId){
	
		$sql="SELECT cnt_id, cnt_code, cnt_title    
		     FROM countries cnt 
			 ORDER BY  cnt_title
			 ;
			 
		$result =  mysql_query($this->con, $sql );
		while ($row = mysql_fetch_assoc($result)) {
			$countryList .= "<option value '".$row[cnt_id]."'" ;
			$countryList .= ($countryId == $row[cnt_id] ) ? 'selected >' : '>' ;
		}
 
		return $countryList;
	}
	
	public function getUsersList($userId){
	
		$sql="SELECT cnt_id, cnt_code, cnt_title    
		     FROM countries cnt 
			 ORDER BY  cnt_title
			 ;
			 
		$result =  mysql_query($this->con, $sql );
		while ($row = mysql_fetch_assoc($result)) {
			$countryList .= "<option value '".$row[cnt_id]."'" ;
			$countryList .= ($countryId == $row[cnt_id] ) ? 'selected >' : '>' ;
		}
 
		return $countryList;
	}
	
}

 $aggregatedLog = new ModelLogAgregator();	
	
?>

<html>
<body>
<form name="fCountry" >
Select Country : <select name="countryId" id = "countryId" ><?=  $aggregatedLog->getCountries($_GET[countryId]) ?>
<button onClick="fCountry.submit()">Select Country</button>
</form>
<form name="fUser" >
Select Country : <select name="userId" id = "userId" ><?=  $aggregatedLog->getUsers($_GET[userId]) ?>
<button onClick="fUser.submit()">Select Country</button>
</form>
<form name="fData" >
<?
if( $_GET[userId] AND $_GET[countryId] ){
	
 $logData =  $aggregatedLog($_GET[dateFrom],$_GET[dateTo],$_GET[userId],$_GET[countryId]);
 
 echo "From: <input name='From' id='From' type=text value='".$logData['title']['From']."' ><br>";
 echo "To: <input name='To' id='To' type=text value='".$logData['title']['To']."' ><br>";
 
 <button onclick='fData.sublit()'></button>
 
 if( $_GET[dateFrom] AND $_GET[dateTo] AND $_GET[userId] AND $_GET[countryId] ){
 
 echo "<br>";
 echo "<table>"
 echo "<tr><td colspan=3>======================================</td></tr>";
 echo "<tr><th>Date</th><th>Successfully sent</th><th>Failed</th></tr>";
 echo "<tr><td colspan=3>======================================</td></tr>";
 
 foreach( $logData as $lData){
	 echo "<tr><td>".$lData['date']."</td><td>".$lData['succs']."</td><td>".$lData['succs']."</td></tr>";	
 }
  echo "</table>";
}
</form>
?>
</html>